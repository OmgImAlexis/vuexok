(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{370:function(t,e,r){"use strict";r.r(e);var s=r(42),a=Object(s.a)({},(function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[r("h1",{attrs:{id:"экшены-из-воркера"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#экшены-из-воркера"}},[t._v("#")]),t._v(" Экшены из воркера")]),t._v(" "),r("p",[t._v('Для "разгрузки" основного потока применяются '),r("a",{attrs:{href:"https://developer.mozilla.org/ru/docs/DOM/Using_web_workers",target:"_blank",rel:"noopener noreferrer"}},[t._v("воркеры"),r("OutboundLink")],1),t._v(". В воркере можно проводить сложные вычисления, которые могли бы привести к просадкам в основном потоке. И затем необходимо передать результат вычислений в основной поток. Если вы используете vuex, то чаще всего вам будет необходимо результаты вычисления воркеров передать в хранилище.")]),t._v(" "),r("p",[t._v("С Vuexok это сделать очень просто. Vuexok позволяет проксировать методы экшенов в воркеры.")]),t._v(" "),r("h2",{attrs:{id:"доработка-инициализации-воркера"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#доработка-инициализации-воркера"}},[t._v("#")]),t._v(" Доработка инициализации воркера")]),t._v(" "),r("p",[t._v("После инициализации воркера надо передать его в метод "),r("code",[t._v("vuexokWorkerWrapper")])]),t._v(" "),r("div",{staticClass:"language-js extra-class"},[r("pre",{pre:!0,attrs:{class:"language-js"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" vuexokWorkerWrapper "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'vuexok/dist/vuexokWorkerWrapper'")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" worker "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Worker")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./worker'")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token function"}},[t._v("vuexokWorkerWrapper")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("worker"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),r("p",[t._v("При этом вы можете так же использовать "),r("a",{attrs:{href:"https://github.com/GoogleChromeLabs/comlink",target:"_blank",rel:"noopener noreferrer"}},[t._v("comlink"),r("OutboundLink")],1),t._v(" вместе с vuexok.")]),t._v(" "),r("h2",{attrs:{id:"доработка-воркера"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#доработка-воркера"}},[t._v("#")]),t._v(" Доработка воркера")]),t._v(" "),r("p",[t._v("Теперь перейдем к коду воркера. Что бы в воркере были доступны экшены модуля достаточно буквально 3 строки.\nВ коде воркера импортируем метод "),r("code",[t._v("vuexokWorkerGetActions")]),t._v(", который нам вернет методы для вызова экшенов модуля.")]),t._v(" "),r("div",{staticClass:"language-js extra-class"},[r("pre",{pre:!0,attrs:{class:"language-js"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" vuexokWorkerGetActions "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'vuexok/dist/vuexokWorkerGetActions'")]),t._v("\n")])])]),r("p",[t._v("Воркер ничего не знает о нашем сторе и модулях, поэтому надо импортировать в воркер тип модуля.")]),t._v(" "),r("p",[t._v("Так как мы не хотим, чтобы в воркере был vuex и код нашего модуля, то импортируем только тип модуля. Typescript версии выше "),r("a",{attrs:{href:"https://devblogs.microsoft.com/typescript/announcing-typescript-3-8-beta/",target:"_blank",rel:"noopener noreferrer"}},[t._v("3.8"),r("OutboundLink")],1),t._v(" позволяет импортировать только тип.")]),t._v(" "),r("div",{staticClass:"language-js extra-class"},[r("pre",{pre:!0,attrs:{class:"language-js"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" type "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("countModule"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@/store/modules/countModule'")]),t._v("\n")])])]),r("p",[t._v("Теперь мы можем получить доступ к экшенам нашего модуля из воркера. Метод "),r("code",[t._v("vuexokWorkerGetActions")]),t._v(" принимает один обязательный параметр - путь к модулю vuex.")]),t._v(" "),r("div",{staticClass:"language-js extra-class"},[r("pre",{pre:!0,attrs:{class:"language-js"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" countModuleActions "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vuexokWorkerGetActions"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" countModule"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'countModule'")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),r("p",[t._v("Простой пример (20 секунд)\n"),r("video",{staticStyle:{width:"100% !important",height:"auto!important"},attrs:{width:"560",height:"240",controls:""}},[r("source",{attrs:{src:"/vuexok/video/createWorker.mp4",type:"video/mp4"}}),t._v("\nYour browser does not support the video tag.\n")])]),t._v(" "),r("h2",{attrs:{id:"обработка-ошибок-экшена"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#обработка-ошибок-экшена"}},[t._v("#")]),t._v(" Обработка ошибок экшена")]),t._v(" "),r("p",[t._v("Для взаимодействия воркера и основного потока используется метод "),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage",target:"_blank",rel:"noopener noreferrer"}},[t._v("postMessage"),r("OutboundLink")],1),t._v(".")]),t._v(" "),r("p",[r("code",[t._v("postMessage")]),t._v(" использует "),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm",target:"_blank",rel:"noopener noreferrer"}},[t._v("алгоритм структурированного клонирования"),r("OutboundLink")],1),t._v(", реализация которого в ff не "),r("a",{attrs:{href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1556604",target:"_blank",rel:"noopener noreferrer"}},[t._v("поддерживает передачу нативных ошибок"),r("OutboundLink")],1),t._v(". По этому вместо оригинального объекта ошибки vuexok передает в воркер поле "),r("code",[t._v("message")]),t._v(" объекта "),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error",target:"_blank",rel:"noopener noreferrer"}},[t._v("Error"),r("OutboundLink")],1),t._v(" и внутри воркера создается новый экземпляр ошибки "),r("code",[t._v("new Error(message)")])])])}),[],!1,null,null,null);e.default=a.exports}}]);